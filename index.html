<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Accounts Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --header-bg: #fff;
            --header-text: #222;
            --button-bg: #f3f3f3;
            --button-text: #222;
            --button-hover-bg: #e0e0e0;
            --card-bg: #fff;
            --card-hover-bg: #e3f2fd;
            --card-dark-bg: #162a4d;
            --card-dark-hover-bg: #203a6c;
        }
        [data-theme="dark"] {
            --header-bg: #0a1733;
            --header-text: #eaf2fb;
            --button-bg: #142a4d;
            --button-text: #eaf2fb;
            --button-hover-bg: #1c3760;
            --card-bg: #162a4d;
            --card-hover-bg: var(--card-dark-hover-bg);
            --card-dark-bg: #203a6c;
            --card-dark-hover-bg: #284a8a;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--header-bg);
            color: var(--header-text);
            transition: background 0.2s, color 0.2s;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .header {
                position: sticky;
                top: 0;
                width: 100%;
                max-width: 100vw;
                background: var(--header-bg);
                color: var(--header-text);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 1rem 0 2.5rem;
                height: 64px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                z-index: 10;
                box-sizing: border-box;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .settings-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        .settings-dropdown-btn {
            width: 90%;
            margin-left: 5%;
            background: var(--button-bg);
            color: var(--button-text);
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 0.75rem 1.2rem;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            transition: background 0.2s, border-color 0.2s;
        }
        .settings-dropdown-btn:hover {
            background: var(--button-hover-bg);
            border-color: #888;
        }
        .settings-btn:hover {
            background: var(--button-hover-bg);
        }
        .settings-btn svg {
            width: 22px;
            height: 22px;
            pointer-events: none;
        }
        .accounts-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .accounts-row {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            padding: 0.5rem 1rem 1rem 1rem;
            box-sizing: border-box;
            overflow-x: auto;
            max-width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #bdbdbd #f3f3f3;
        }
            .category-row {
                background: var(--button-bg);
                border-radius: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.07);
                margin-bottom: 1.2rem !important;
                padding: 1rem 0.5rem 0.5rem 0.5rem;
                position: relative;
            }
            .category-header {
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 0.5rem;
                margin-bottom: 0.7rem;
                display: flex;
                align-items: center;
                gap: 1.2rem;
            }
            .collapse-btn {
                background: none;
                border: none;
                color: #888;
                font-size: 1.2rem;
                cursor: pointer;
                margin-right: 0.5rem;
                transition: color 0.2s;
            }
            .collapse-btn:hover {
                color: #2196f3;
            }
        .accounts-row::-webkit-scrollbar {
            height: 8px;
        }
        .accounts-row::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 8px;
        }
        .accounts-row::-webkit-scrollbar-track {
            background: #f3f3f3;
            border-radius: 8px;
        }
        .account-card {
                background: var(--card-bg);
                color: var(--button-text);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                padding: 1rem;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                justify-content: center;
                min-height: 120px;
                min-width: 120px;
                transition: box-shadow 0.2s;
                width: 180px;
                height: 160px;
                align-items: center;
                justify-content: center;
        }
        .account-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
            background: var(--card-hover-bg);
        }
        .account-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .account-details {
            font-size: 0.95rem;
            color: var(--header-text);
        }
        .account-tag {
            display: inline-block;
            padding: 0.2rem 0.7rem;
            font-size: 0.85rem;
            border-radius: 8px;
            background: #e0e0e0;
            color: #333;
            margin-bottom: 0.5rem;
            margin-top: 0.2rem;
            font-weight: 500;
        }
        .account-edit-input {
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 0.3rem;
            width: 90%;
            box-sizing: border-box;
        }
        .account-edit-select {
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 0.3rem;
            width: 95%;
            box-sizing: border-box;
        }
        .summary-card {
            width: 340px;
            min-height: 700px;
            background: var(--button-bg);
            color: var(--button-text);
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 2rem 1rem;
            perspective: 1200px;
            box-sizing: border-box;
            position: relative;
        }
        .summary-card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.7s cubic-bezier(.4,2,.3,1);
            transform-style: preserve-3d;
        }
        .summary-card.flipped .summary-card-inner {
            transform: rotateY(180deg);
        }
        .summary-card-face {
            position: absolute;
            width: 100%;
            min-height: 100%;
            height: auto;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .summary-card-front {
            z-index: 2;
        }
        .summary-card-back {
            transform: rotateY(180deg);
            z-index: 1;
        }
        .summary-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.6rem;
            text-align: center;
            width: 100%;
        }
        .summary-pie {
            margin-bottom: 1rem;
            width: 320px;
            height: 320px;
        }
        .summary-list {
            width: 100%;
            font-size: 0.92rem;
        }
    </style>
</head>
<body>
    <!-- PIN Setup/Unlock Modal -->
    <div id="pinModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:10000; align-items:center; justify-content:center;">
        <form id="pinForm" style="background:var(--header-bg); color:var(--header-text); padding:2rem 1.5rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:320px; display:flex; flex-direction:column; align-items:center; gap:1.2rem;">
            <div id="pinModalTitle" style="font-size:1.2rem; font-weight:600; margin-bottom:1rem;"></div>
            <input id="pinInput" type="password" maxlength="8" style="padding:0.7rem; font-size:1.1rem; border-radius:8px; border:1px solid #ccc; width:90%; text-align:center;" autocomplete="off" required />
            <button type="submit" style="margin-top:1rem; padding:0.5rem 1.5rem; font-size:1rem; background:#2196f3; color:#fff; border:none; border-radius:8px; cursor:pointer;">Submit</button>
            <div id="pinError" style="color:#d32f2f; font-size:0.98rem; margin-top:0.5rem; display:none;"></div>
        </form>
    </div>
    <div id="customAlertModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:var(--header-bg); color:var(--header-text); padding:2rem 1.5rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:320px; display:flex; flex-direction:column; align-items:center; gap:1.2rem;">
            <div id="customAlertMessage" style="font-size:1.08rem; margin-bottom:1.2rem; text-align:center;"></div>
            <div style="display:flex; gap:1.2rem; justify-content:center;">
                <button id="customAlertCancel" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Cancel</button>
                <button id="customAlertConfirm" style="background:#f44336; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Delete</button>
            </div>
        </div>
    </div>
    <div id="mainContent">
        <header class="header">
            <div class="header-title">Accounts Dashboard</div>
            <div style="position: relative; display: flex; align-items: center; gap: 0.5rem;">
                <button class="settings-btn" id="quickLockBtn" title="Lock Dashboard" style="margin-right:0.2rem;">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none">
                        <path d="M7 10V7a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="5" y="10" width="14" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="12" cy="15" r="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </button>
                <button class="settings-btn" id="settingsBtn" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.43-2.88l1.77-1.02a.5.5 0 0 0 .18-.68l-1.68-2.91a.5.5 0 0 0-.61-.23l-2.08.83a7.03 7.03 0 0 0-1.52-.88l-.32-2.19a.5.5 0 0 0-.5-.42h-3.36a.5.5 0 0 0-.5.42l-.32 2.19a7.03 7.03 0 0 0-1.52.88l-2.08-.83a.5.5 0 0 0-.61.23l-1.68 2.91a.5.5 0 0 0 .18.68l1.77 1.02c-.04.32-.07.65-.07.98s.03.66.07.98l-1.77 1.02a.5.5 0 0 0-.18.68l1.68 2.91a.5.5 0 0 0 .61.23l2.08-.83c.47.34.98.63 1.52.88l.32 2.19a.5.5 0 0 0 .5.42h3.36a.5.5 0 0 0 .5-.42l.32-2.19c.54-.25 1.05-.54 1.52-.88l2.08.83a.5.5 0 0 0 .61-.23l1.68-2.91a.5.5 0 0 0-.18-.68l-1.77-1.02c.04-.32.07-.65.07-.98s-.03-.66-.07-.98z" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </button>
                <div id="settingsDropdown" style="display:none; position:absolute; right:0; top:48px; background:var(--header-bg); color:var(--header-text); box-shadow:0 2px 8px rgba(0,0,0,0.08); border-radius:8px; min-width:220px; padding:0.5rem 0; z-index:100;">
                    <button id="themeToggleBtn" class="settings-dropdown-btn">Toggle Dark/Light Mode</button>
                    <button id="reorderCategoriesBtn" class="settings-dropdown-btn">Reorder Categories</button>
                    <button id="exportConfigBtn" class="settings-dropdown-btn">Export Config</button>
                    <button id="importConfigBtn" class="settings-dropdown-btn">Import Config</button>
                    <button id="resetAllDataBtn" class="settings-dropdown-btn" style="color:#d32f2f;">Reset All Data</button>
                    <div style="padding: 0.75rem 1.5rem;">
                        <label for="birthday" style="font-size:1rem; display:block; margin-bottom:0.3rem;">Birthday</label>
                        <input type="date" id="birthday" style="width:100%; padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc; margin-bottom:0.7rem;" />
                        <label for="retirementAge" style="font-size:1rem; display:block; margin-bottom:0.3rem;">Retirement Age</label>
                        <input type="number" id="retirementAge" min="1" max="100" style="width:100%; padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc; margin-bottom:0.7rem;" />
                        <div id="retirementSummary" style="font-size:0.98rem; margin-top:0.5rem; color:var(--header-text);"></div>
                    </div>
                </div>
            </div>
        </header>
        <main style="display: flex; width: 100vw; min-height: calc(100vh - 64px);">
        <!-- Quick Balance Update Modal -->
        <div id="quickBalanceModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:9999; align-items:center; justify-content:center;">
            <form id="quickBalanceForm" style="background:var(--header-bg); color:var(--header-text); padding:2rem 1.5rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:340px; display:flex; flex-direction:column; align-items:center; gap:1.2rem;">
                <div style="font-size:1.2rem; font-weight:600; margin-bottom:1rem;">Quick Balance Update</div>
                <div id="quickBalanceList" style="width:320px; max-height:400px; overflow-y:auto; margin-bottom:1rem;"></div>
                <div style="display:flex; gap:1.2rem; justify-content:center; margin-top:1.2rem;">
                    <button type="button" id="cancelQuickBalanceBtn" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Cancel</button>
                    <button type="submit" style="background:#4caf50; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Update</button>
                </div>
            </form>
        </div>
        <!-- Category Reorder Modal -->
        <div id="reorderCategoriesModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:var(--header-bg); color:var(--header-text); padding:2rem 1.5rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:320px; display:flex; flex-direction:column; align-items:center; gap:1.2rem;">
            <div style="font-size:1.2rem; font-weight:600; margin-bottom:1rem;">Reorder Categories</div>
            <div id="categoriesSortableList" style="width:320px;">
                <!-- Categories will be rendered here -->
            </div>
            <div style="display:flex; gap:1.2rem; justify-content:center; margin-top:1.2rem;">
                <button id="cancelReorderCategoriesBtn" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Cancel</button>
                <button id="saveReorderCategoriesBtn" style="background:#2196f3; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>
    <section style="width: 75vw; max-width: 75vw; padding-left: 2.5rem;">
            <button id="addAccountBtn" style="margin: 2rem 1rem 0.5rem 1.5rem; padding: 0.5rem 1.5rem; font-size: 1rem; background: var(--button-bg); color: var(--button-text); border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">Add Account</button>
            <button id="quickBalanceBtn" title="Quickly update the balances for all your accounts from one place." style="margin: 2rem 1rem 0.5rem 0; padding: 0.5rem 1.5rem; font-size: 1rem; background: #2196f3; color: #fff; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">Quick Balance Update</button>
            <a href="https://joshdisciple.github.io/Custom-Income-Portfolio-Tool/#overview" target="_blank" title="Open the Custom Income Portfolio Tool to build and analyze your own income portfolio." style="margin: 2rem 1rem 0.5rem 0; padding: 0.5rem 1.5rem; font-size: 1rem; background: #4caf50; color: #fff; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-decoration: none; display: inline-block;">Go to Custom Income Portfolio Tool</a>
            <button id="portfolioSummaryBtn" style="margin: 2rem 1rem 0.5rem 0; padding: 0.5rem 1.5rem; font-size: 1rem; background: #ff9800; color: #fff; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">Notes</button>
            <div id="portfolioSummaryModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:9999; align-items:center; justify-content:center;">
                <div style="background:var(--header-bg); color:var(--header-text); padding:2rem 1.5rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:400px; max-width:90vw; display:flex; flex-direction:column; align-items:center; gap:1.2rem;">
                    <div style="font-size:1.2rem; font-weight:600; margin-bottom:1rem;">Notes</div>
                    <textarea id="portfolioSummaryText" style="width:350px; height:220px; padding:1rem; font-size:1rem; border-radius:8px; border:1px solid #ccc; background:var(--button-bg); color:var(--button-text); resize:vertical;"></textarea>
                    <div style="width:100%; display:flex; gap:1rem; justify-content:center; margin-bottom:0.5rem;">
                        <select id="portfolioSummarySelect" style="flex:1; padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;"></select>
                        <button id="savePortfolioSummaryBtn" style="background:#4caf50; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Save</button>
                        <button id="openPortfolioSummaryBtn" style="background:#2196f3; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Open</button>
                        <button id="deletePortfolioSummaryBtn" style="background:#f44336; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Delete</button>
                        <button id="closePortfolioSummaryBtn" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Close</button>
                    </div>
                </div>
            </div>
            <div id="addAccountModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:200; align-items:center; justify-content:center;">
                <form id="accountForm" style="background:var(--header-bg); color:var(--header-text); padding:2rem; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.12); min-width:320px; display:flex; flex-direction:column; gap:1rem;">
                    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 220px; display: flex; flex-direction: column; gap: 0.5rem;">
                            <label for="accountType">Account Type</label>
                            <select id="accountType" required style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;">
                                <option value="">Select type...</option>
                                <option>Emergency Fund</option>
                                <option>Checking Account</option>
                                <option>Savings Account</option>
                                <option>Money Market Account</option>
                                <option>Certificate of Deposit (CD)</option>
                                <option>Brokerage Account</option>
                                <option>Retirement Account (IRA)</option>
                                <option>401(k)</option>
                                <option>Roth IRA</option>
                                <option>SEP IRA</option>
                                <option>Trust Account</option>
                                <option>529 College Savings</option>
                                <option>Health Savings Account (HSA)</option>
                                <option>Credit Card</option>
                                <option>Loan Account</option>
                                <option>Other Investment</option>
                            </select>
                            <label for="accountManagement">Management Type</label>
                            <select id="accountManagement" required style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;">
                                <option value="">Select management...</option>
                                <option>Personally Managed</option>
                                <option>Professionally Managed</option>
                                <option>Robo Advised</option>
                            </select>
                            <label for="accountName">Account Name</label>
                            <input id="accountName" type="text" required placeholder="e.g. Chase Checking" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                            <label for="accountBalance">Balance</label>
                            <input id="accountBalance" type="number" required min="0" step="0.01" placeholder="e.g. 1000.00" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                            <label for="accountInterest">Expected Interest Rate (%)</label>
                            <input id="accountInterest" type="number" min="0" step="0.01" placeholder="e.g. 5.00" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                        </div>
                        <div style="flex: 1; min-width: 220px; display: flex; flex-direction: column; gap: 0.5rem;">
                            <label for="accountTarget">Target Balance</label>
                            <input id="accountTarget" type="number" min="0" step="0.01" placeholder="e.g. 100000.00" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                            <label for="accountContribution">Contribution Amount</label>
                            <input id="accountContribution" type="number" min="0" step="0.01" placeholder="e.g. 500.00" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                            <label for="accountSchedule">Contribution Schedule</label>
                            <select id="accountSchedule" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Annually">Annually</option>
                                <option value="None">None</option>
                            </select>
                            <label for="accountExpense">Expense Amount</label>
                            <input id="accountExpense" type="number" min="0" step="0.01" placeholder="e.g. 200.00" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;" />
                            <label for="accountExpenseSchedule">Expense Schedule</label>
                            <select id="accountExpenseSchedule" style="padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Annually">Annually</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end;">
                        <button type="button" id="cancelAccountBtn" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Cancel</button>
                        <button type="submit" style="background:#4caf50; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Add</button>
                    </div>
                </form>
            </div>
            <section class="accounts-grid" id="accountsGrid" style="display: flex; flex-direction: column; gap: 0.5rem; padding-left: 1rem;">
                <!-- Account cards will be added here -->
                <div id="dragOverlay" style="display:none; position:fixed; pointer-events:none; z-index:9999; background:rgba(0,0,0,0.08); border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12);"></div>
            </section>
        </section>
    <aside style="width: 25vw; min-width: 300px; max-width: 400px; position: sticky; top: 102px; right: 0; height: fit-content; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 2rem 1rem; box-sizing: border-box; background: transparent;">
            <div id="summaryCard" class="summary-card">
                <div class="summary-card-inner" id="summaryCardInner">
                    <div class="summary-card-face summary-card-front">
                        <div style="width:100%; display:flex; justify-content:center; gap:1rem; margin-bottom:1rem;">
                            <button id="summaryToggleCurrent" style="background:#2196f3; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer; font-size:0.95rem; font-weight:600;">Current</button>
                            <button id="summaryToggleProjected" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer; font-size:0.95rem; font-weight:600;">Projected</button>
                        </div>
                        <div id="summaryCurrentSection">
                            <h2 class="summary-title">Balance Summary</h2>
                            <canvas id="summaryPie" class="summary-pie" width="320" height="320"></canvas>
                            <div id="summaryList" class="summary-list"></div>
                        </div>
                    </div>
                    <div class="summary-card-face summary-card-back">
                        <div style="width:100%; display:flex; justify-content:center; gap:1rem; margin-bottom:1rem;">
                            <button id="summaryToggleCurrentBack" style="background:var(--button-bg); color:var(--button-text); border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer; font-size:0.95rem; font-weight:600;">Current</button>
                            <button id="summaryToggleProjectedBack" style="background:#2196f3; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer; font-size:0.95rem; font-weight:600;">Projected</button>
                        </div>
                        <div id="summaryProjectedSection" style="width:100%;">
                            <h2 class="summary-title">Projected Summary</h2>
                            <canvas id="projectedPie" class="summary-pie" width="320" height="320"></canvas>
                            <div id="projectedList" class="summary-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        </main>
        </main>
        <footer style="width:100vw; background:var(--header-bg); color:var(--header-text); text-align:center; padding:2rem 0 1.5rem 0; font-size:1rem; border-top:1px solid #e0e0e0; margin-top:2rem;">
            <div style="margin-bottom:0.7rem;">© 2025 JoshDisciple. This tool is for educational purposes only and does not constitute financial advice.</div>
            <div style="margin-bottom:0.7rem;">Created by <a href="https://twitter.com/JoshDisciple" target="_blank" style="color:#2196f3; text-decoration:none;">@JoshDisciple</a></div>
            <div style="margin-bottom:0.7rem;">Version: 1.0.0 | Release Date: Aug 16, 2025</div>
            <div><a href="https://www.patreon.com/JoshDisciple" target="_blank" style="color:#4caf50; text-decoration:none; font-weight:600;">Support development of this tool on Patreon</a></div>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // --- PIN Setup/Unlock Logic ---
    // Quick Lock Button Logic
    const quickLockBtn = document.getElementById('quickLockBtn');
    if (quickLockBtn) {
        quickLockBtn.onclick = function() {
            lockDashboard();
        };
    }
    const pinModal = document.getElementById('pinModal');
    const pinForm = document.getElementById('pinForm');
    const pinInput = document.getElementById('pinInput');
    const pinModalTitle = document.getElementById('pinModalTitle');
    const pinError = document.getElementById('pinError');
    const mainContent = document.getElementById('mainContent');
    let pinLocked = false;
    let inactivityTimer = null;
    let lastActivity = Date.now();

    function showPinModal(setup = false) {
        pinModal.style.display = 'flex';
        pinInput.value = '';
        pinError.style.display = 'none';
        pinModalTitle.textContent = setup ? 'Set a PIN to unlock the dashboard' : 'Enter PIN to unlock';
        pinInput.focus();
    }

    function hidePinModal() {
        pinModal.style.display = 'none';
        pinError.style.display = 'none';
    }

    function lockDashboard() {
        mainContent.style.display = 'none';
        pinLocked = true;
        showPinModal(false);
    }

    function unlockDashboard() {
        mainContent.style.display = '';
        pinLocked = false;
        hidePinModal();
        resetInactivityTimer();
    }

    function resetInactivityTimer() {
        lastActivity = Date.now();
        if (inactivityTimer) clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            if (!pinLocked) lockDashboard();
        }, 5 * 60 * 1000); // 5 minutes
    }

    // Listen for user activity
    ['mousemove', 'keydown', 'touchstart', 'click'].forEach(evt => {
        document.addEventListener(evt, () => {
            if (!pinLocked) resetInactivityTimer();
        });
    });

    // PIN setup/unlock logic
    function getStoredPin() {
        return localStorage.getItem('dashboardPin');
    }

    function setStoredPin(pin) {
        localStorage.setItem('dashboardPin', pin);
    }

    // On page load, check if PIN is set
    window.addEventListener('DOMContentLoaded', () => {
        if (!getStoredPin()) {
            mainContent.style.display = 'none';
            showPinModal(true);
        } else {
            mainContent.style.display = '';
            resetInactivityTimer();
        }
    });

    pinForm.onsubmit = function(e) {
        e.preventDefault();
        const pin = pinInput.value.trim();
        if (!pin || pin.length < 4) {
            pinError.textContent = 'PIN must be at least 4 digits.';
            pinError.style.display = 'block';
            return;
        }
        if (!getStoredPin()) {
            setStoredPin(pin);
            unlockDashboard();
        } else {
            if (pin === getStoredPin()) {
                unlockDashboard();
            } else {
                pinError.textContent = 'Incorrect PIN. Try again.';
                pinError.style.display = 'block';
            }
        }
    };

    // Optionally, add a way to reset/change PIN in settings
    // ...existing code...
    // Quick Balance Update Modal Logic
    const quickBalanceBtn = document.getElementById('quickBalanceBtn');
    const quickBalanceModal = document.getElementById('quickBalanceModal');
    const quickBalanceList = document.getElementById('quickBalanceList');
    const quickBalanceForm = document.getElementById('quickBalanceForm');
    const cancelQuickBalanceBtn = document.getElementById('cancelQuickBalanceBtn');

    function openQuickBalanceModal() {
        quickBalanceList.innerHTML = '';
        // Use global 'accounts' array
        if (typeof accounts !== 'undefined' && Array.isArray(accounts)) {
            accounts.forEach((acc, i) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.marginBottom = '0.7rem';
                row.innerHTML = `
                    <span style="max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${acc.name || acc.type}</span>
                    <input type="number" step="0.01" min="0" value="${acc.balance || 0}" data-index="${i}" style="width:120px; padding:0.4rem; font-size:1rem; border-radius:6px; border:1px solid #ccc; background:var(--button-bg); color:var(--button-text);" />
                `;
                quickBalanceList.appendChild(row);
            });
        }
        quickBalanceModal.style.display = 'flex';
    }

    quickBalanceBtn.onclick = openQuickBalanceModal;
    cancelQuickBalanceBtn.onclick = function() {
        quickBalanceModal.style.display = 'none';
    };
    quickBalanceForm.onsubmit = function(e) {
        e.preventDefault();
        // Update balances in global 'accounts' array
        const inputs = quickBalanceList.querySelectorAll('input');
        inputs.forEach(input => {
            const idx = parseInt(input.getAttribute('data-index'));
            if (!isNaN(idx) && accounts[idx]) {
                accounts[idx].balance = parseFloat(input.value) || 0;
            }
        });
        quickBalanceModal.style.display = 'none';
        // Re-render UI if needed
        if (typeof renderSummary === 'function') renderSummary();
        if (typeof renderProjectedSummary === 'function') renderProjectedSummary();
        if (typeof renderAccountsGrid === 'function') renderAccountsGrid();
    };
        // Notes Modal Logic
        const portfolioSummaryBtn = document.getElementById('portfolioSummaryBtn');
        const portfolioSummaryModal = document.getElementById('portfolioSummaryModal');
        const portfolioSummaryText = document.getElementById('portfolioSummaryText');
        const portfolioSummarySelect = document.getElementById('portfolioSummarySelect');
        const savePortfolioSummaryBtn = document.getElementById('savePortfolioSummaryBtn');
        const openPortfolioSummaryBtn = document.getElementById('openPortfolioSummaryBtn');
        const deletePortfolioSummaryBtn = document.getElementById('deletePortfolioSummaryBtn');
        const closePortfolioSummaryBtn = document.getElementById('closePortfolioSummaryBtn');

        function getPortfolioSummaries() {
            return JSON.parse(localStorage.getItem('portfolioSummaries') || '{}');
        }
        function setPortfolioSummaries(summaries) {
            localStorage.setItem('portfolioSummaries', JSON.stringify(summaries));
        }
        function refreshPortfolioSummarySelect() {
            const summaries = getPortfolioSummaries();
            portfolioSummarySelect.innerHTML = '<option value="">(New Note)</option>' +
                Object.keys(summaries).map(name => `<option value="${name}">${name}</option>`).join('');
        }
        portfolioSummaryBtn.onclick = () => {
            portfolioSummaryModal.style.display = 'flex';
            refreshPortfolioSummarySelect();
            portfolioSummaryText.value = '';
            portfolioSummarySelect.value = '';
        };
        closePortfolioSummaryBtn.onclick = () => {
            portfolioSummaryModal.style.display = 'none';
        };
        savePortfolioSummaryBtn.onclick = () => {
            let name = portfolioSummarySelect.value;
            if (!name) {
                name = prompt('Enter a name for this summary:');
                if (!name) return;
            }
            const summaries = getPortfolioSummaries();
            summaries[name] = portfolioSummaryText.value;
            setPortfolioSummaries(summaries);
            refreshPortfolioSummarySelect();
            portfolioSummarySelect.value = name;
            alert('Summary saved!');
        };
        openPortfolioSummaryBtn.onclick = () => {
            const name = portfolioSummarySelect.value;
            if (!name) return;
            const summaries = getPortfolioSummaries();
            portfolioSummaryText.value = summaries[name] || '';
        };
        deletePortfolioSummaryBtn.onclick = () => {
            const name = portfolioSummarySelect.value;
            if (!name) return;
            if (!confirm('Delete this summary?')) return;
            const summaries = getPortfolioSummaries();
            delete summaries[name];
            setPortfolioSummaries(summaries);
            refreshPortfolioSummarySelect();
            portfolioSummaryText.value = '';
            portfolioSummarySelect.value = '';
        };
        portfolioSummarySelect.onchange = () => {
            const name = portfolioSummarySelect.value;
            if (!name) {
                portfolioSummaryText.value = '';
            } else {
                const summaries = getPortfolioSummaries();
                portfolioSummaryText.value = summaries[name] || '';
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Category reorder modal logic
        const reorderCategoriesBtn = document.getElementById('reorderCategoriesBtn');
        const reorderCategoriesModal = document.getElementById('reorderCategoriesModal');
        const categoriesSortableList = document.getElementById('categoriesSortableList');
        const cancelReorderCategoriesBtn = document.getElementById('cancelReorderCategoriesBtn');
        const saveReorderCategoriesBtn = document.getElementById('saveReorderCategoriesBtn');
        let sortableInstance = null;

        reorderCategoriesBtn.onclick = function() {
            // Get current order
            const defaultCategories = [
                'Emergency Fund',
                'Retirement',
                'HSA',
                'Taxable Brokerage',
                'Cash Management',
                'Checkings',
                'Savings',
                'Other'
            ];
            let categories = JSON.parse(localStorage.getItem('categoryOrder') || 'null') || defaultCategories;
            categoriesSortableList.innerHTML = categories.map(cat =>
                `<div class="sortable-category-item" data-category="${cat}" style="padding:0.7rem 1rem; background:var(--button-bg); color:var(--button-text); border-radius:8px; margin-bottom:0.5rem; font-size:1.1rem; font-weight:500; display:flex; align-items:center; gap:1rem; cursor:grab;">
                    <span style="font-size:1.3rem; color:#bbb; margin-right:0.7rem;">&#x2630;</span>
                    <span>${cat}</span>
                </div>`
            ).join('');
            reorderCategoriesModal.style.display = 'flex';
            // Initialize SortableJS
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = Sortable.create(categoriesSortableList, {
                animation: 180,
                handle: '.sortable-category-item > span:first-child',
                draggable: '.sortable-category-item',
            });
        };
        cancelReorderCategoriesBtn.onclick = function() {
            reorderCategoriesModal.style.display = 'none';
        };
        saveReorderCategoriesBtn.onclick = function() {
            // Get new order
            const newOrder = Array.from(categoriesSortableList.querySelectorAll('.sortable-category-item')).map(item => item.getAttribute('data-category'));
            localStorage.setItem('categoryOrder', JSON.stringify(newOrder));
            reorderCategoriesModal.style.display = 'none';
            renderAccounts();
        };
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const exportConfigBtn = document.getElementById('exportConfigBtn');
        const importConfigBtn = document.getElementById('importConfigBtn');
        const resetAllDataBtn = document.getElementById('resetAllDataBtn');
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCancel = document.getElementById('customAlertCancel');
        const customAlertConfirm = document.getElementById('customAlertConfirm');

        // Reset All Data logic
        resetAllDataBtn.onclick = () => {
            customAlertMessage.textContent = 'Are you sure you want to reset ALL data? This action cannot be undone.';
            customAlertModal.style.display = 'flex';
        };
        customAlertCancel.onclick = () => {
            customAlertModal.style.display = 'none';
        };
        customAlertConfirm.onclick = () => {
            // Clear all relevant localStorage keys
            localStorage.removeItem('accounts');
            localStorage.removeItem('categoryOrder');
            localStorage.removeItem('collapsedCategories');
            localStorage.removeItem('birthday');
            localStorage.removeItem('retirementAge');
            accounts = [];
            renderAccounts();
            updateRetirementSummary();
            customAlertModal.style.display = 'none';
            customAlertMessage.textContent = 'All data has been reset.';
            customAlertConfirm.style.display = 'none';
            customAlertCancel.textContent = 'OK';
            customAlertModal.style.display = 'flex';
        };

        // Export config logic
        exportConfigBtn.onclick = () => {
            const config = {
                accounts: JSON.parse(localStorage.getItem('accounts') || '[]'),
                categoryOrder: JSON.parse(localStorage.getItem('categoryOrder') || 'null'),
                collapsedCategories: JSON.parse(localStorage.getItem('collapsedCategories') || '[]'),
                birthday: localStorage.getItem('birthday') || '',
                retirementAge: localStorage.getItem('retirementAge') || ''
            };
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'account-config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            settingsDropdown.style.display = 'none';
        };

        // Import config logic
        importConfigBtn.onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const config = JSON.parse(ev.target.result);
                        if (config.accounts) localStorage.setItem('accounts', JSON.stringify(config.accounts));
                        if (config.categoryOrder) localStorage.setItem('categoryOrder', JSON.stringify(config.categoryOrder));
                        if (config.collapsedCategories) localStorage.setItem('collapsedCategories', JSON.stringify(config.collapsedCategories));
                        if (config.birthday) localStorage.setItem('birthday', config.birthday);
                        if (config.retirementAge) localStorage.setItem('retirementAge', config.retirementAge);
                        renderAccounts();
                        updateRetirementSummary();
                        customAlertMessage.textContent = 'Config imported successfully!';
                        customAlertConfirm.style.display = 'none';
                        customAlertCancel.textContent = 'OK';
                        customAlertModal.style.display = 'flex';
                        customAlertCancel.onclick = () => {
                            customAlertModal.style.display = 'none';
                            location.reload();
                        };
                    } catch (err) {
                        alert('Failed to import config: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
            settingsDropdown.style.display = 'none';
        };
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
        }
        let theme = localStorage.getItem('theme') || 'light';
        setTheme(theme);
        themeToggleBtn.onclick = () => {
            theme = theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            setTheme(theme);
            settingsDropdown.style.display = 'none';
        };
        settingsBtn.onclick = (e) => {
            e.stopPropagation();
            settingsDropdown.style.display = settingsDropdown.style.display === 'none' ? 'block' : 'none';
        };
        document.addEventListener('click', (e) => {
            if (!settingsDropdown.contains(e.target) && e.target !== settingsBtn) {
                settingsDropdown.style.display = 'none';
            }
        });
        // Retirement target date logic
        const birthdayInput = document.getElementById('birthday');
        const retirementAgeInput = document.getElementById('retirementAge');
        const retirementSummary = document.getElementById('retirementSummary');
        function updateRetirementSummary() {
            const birthday = birthdayInput.value;
            const retirementAge = parseInt(retirementAgeInput.value);
            if (!birthday || !retirementAge) {
                retirementSummary.textContent = '';
                return;
            }
            const birthDate = new Date(birthday);
            const targetDate = new Date(birthDate);
            targetDate.setFullYear(birthDate.getFullYear() + retirementAge);
            const now = new Date();
            let months = (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth());
            if (targetDate.getDate() < now.getDate()) months--;
            const years = Math.floor(months / 12);
            const remMonths = months % 12;
            retirementSummary.innerHTML = `<strong>Target Date:</strong> ${targetDate.toLocaleDateString()}<br><strong>Time Remaining:</strong> ${years} years${remMonths > 0 ? (', ' + remMonths + ' months') : ''}`;
        }
        birthdayInput.value = localStorage.getItem('birthday') || '';
        retirementAgeInput.value = localStorage.getItem('retirementAge') || '';
        birthdayInput.onchange = () => {
            localStorage.setItem('birthday', birthdayInput.value);
            updateRetirementSummary();
        };
        retirementAgeInput.onchange = () => {
            localStorage.setItem('retirementAge', retirementAgeInput.value);
            updateRetirementSummary();
        };
        updateRetirementSummary();
        // Account management logic
        let accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
        let editIndex = null;

        function getCategory(type) {
            if (["Emergency Fund"].includes(type)) return "Emergency Fund";
            if (["Retirement Account (IRA)", "401(k)", "Roth IRA", "SEP IRA"].includes(type)) return "Retirement";
            if (["Health Savings Account (HSA)"].includes(type)) return "HSA";
            if (["Brokerage Account", "Other Investment", "Trust Account"].includes(type)) return "Taxable Brokerage";
            if (["Money Market Account", "Certificate of Deposit (CD)"].includes(type)) return "Cash Management";
            if (["Checking Account"].includes(type)) return "Checkings";
            if (["Savings Account", "529 College Savings"].includes(type)) return "Savings";
            return "Other";
        }

        function weightedYield(cat) {
            const catAccounts = accounts.filter(acc => getCategory(acc.type) === cat);
            let totalBalance = catAccounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            if (totalBalance === 0) return 0;
            let weightedSum = catAccounts.reduce((sum, acc) => sum + (parseFloat(acc.balance || 0) * (parseFloat(acc.interest || 0) / 100)), 0);
            return (weightedSum / totalBalance) * 100;
        }

        function renderAccounts() {
            accountsGrid.innerHTML = '';
            // Get or set category order from localStorage
            const defaultCategories = [
                'Emergency Fund',
                'Retirement',
                'HSA',
                'Taxable Brokerage',
                'Cash Management',
                'Checkings',
                'Savings',
                'Other'
            ];
            let categories = JSON.parse(localStorage.getItem('categoryOrder') || 'null') || defaultCategories;
                let collapsedCats = JSON.parse(localStorage.getItem('collapsedCategories') || '[]');
            categories.forEach(cat => {
                const catAccounts = accounts.filter(acc => getCategory(acc.type) === cat);
                if (catAccounts.length > 0) {
                    const row = document.createElement('div');
                    row.className = 'category-row';
                    row.setAttribute('data-category', cat);
                    row.style.marginBottom = '0.5rem';
                    const yieldVal = weightedYield(cat);
                        row.innerHTML = `<div class="category-header">
                            <button class="collapse-btn" title="${collapsedCats.includes(cat) ? 'Expand' : 'Collapse'}" data-collapse-cat="${cat}">
                                ${collapsedCats.includes(cat) ? '&#9654;' : '&#9660;'}
                            </button>
                            <span style="font-size:1.2rem; font-weight:600;">${cat}</span>
                            <span style="font-size:1rem; color:#2196f3; font-weight:500;">${yieldVal ? `Yield: ${yieldVal.toFixed(2)}%` : ''}</span>
                        </div>`;
                        if (!collapsedCats.includes(cat)) {
                            const grid = document.createElement('div');
                            grid.className = 'accounts-row';
                            catAccounts.forEach((acc, idx) => {
                                const card = document.createElement('div');
                                card.className = 'account-card';
                                card.innerHTML = `
                                    <span class="account-tag" data-field="management">${acc.management || ''}</span>
                                    <div class="account-title" data-field="name">${acc.name}</div>
                                    <div class="account-details" data-field="type">${acc.type}</div>
                                    <div class="account-details" data-field="balance">Balance: $${parseFloat(acc.balance).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                                    <div style="margin-top:0.75rem; display:flex; gap:0.5rem;">
                                        <button class="edit-btn" data-idx="${accounts.indexOf(acc)}" style="background:#2196f3; color:#fff; border:none; border-radius:6px; padding:0.3rem 0.8rem; cursor:pointer; font-size:0.95rem;">View</button>
                                        <button class="delete-btn" data-idx="${accounts.indexOf(acc)}" style="background:#f44336; color:#fff; border:none; border-radius:6px; padding:0.3rem 0.8rem; cursor:pointer; font-size:0.95rem;">Delete</button>
                                    </div>
                                `;
                                // ...existing code...
                                card.querySelectorAll('[data-field]').forEach(fieldEl => {
                                    fieldEl.onclick = (e) => {
                                        const field = fieldEl.getAttribute('data-field');
                                        let input;
                                        if (field === 'management') {
                                            input = document.createElement('select');
                                            input.className = 'account-edit-select';
                                            ['Personally Managed','Professionally Managed','Robo Advised'].forEach(opt => {
                                                const option = document.createElement('option');
                                                option.value = opt;
                                                option.textContent = opt;
                                                if (opt === acc.management) option.selected = true;
                                                input.appendChild(option);
                                            });
                                        } else if (field === 'type') {
                                            input = document.createElement('select');
                                            input.className = 'account-edit-select';
                                            [
                                                'Emergency Fund','Checking Account','Savings Account','Money Market Account','Certificate of Deposit (CD)','Brokerage Account','Retirement Account (IRA)','401(k)','Roth IRA','SEP IRA','Trust Account','529 College Savings','Health Savings Account (HSA)','Credit Card','Loan Account','Other Investment'
                                            ].forEach(opt => {
                                                const option = document.createElement('option');
                                                option.value = opt;
                                                option.textContent = opt;
                                                if (opt === acc.type) option.selected = true;
                                                input.appendChild(option);
                                            });
                                        } else if (field === 'balance') {
                                            input = document.createElement('input');
                                            input.type = 'number';
                                            input.className = 'account-edit-input';
                                            input.value = acc.balance;
                                            input.min = 0;
                                            input.step = '0.01';
                                        } else {
                                            input = document.createElement('input');
                                            input.type = 'text';
                                            input.className = 'account-edit-input';
                                            input.value = acc[field];
                                        }
                                        fieldEl.replaceWith(input);
                                        input.focus();
                                        input.onblur = () => {
                                            let newValue = input.value;
                                            if (field === 'balance') newValue = parseFloat(newValue).toFixed(2);
                                            if (field === 'type') acc.category = getCategory(newValue);
                                            acc[field] = newValue;
                                            localStorage.setItem('accounts', JSON.stringify(accounts));
                                            renderAccounts();
                                        };
                                        input.onkeydown = (ev) => {
                                            if (ev.key === 'Enter') {
                                                input.blur();
                                            }
                                        };
                                    };
                                });
                                grid.appendChild(card);
                            });
                            row.appendChild(grid);
                        }
                        accountsGrid.appendChild(row);
                    }
                // ...existing code...
                });
                // Collapse/expand event listeners
                document.querySelectorAll('.collapse-btn').forEach(btn => {
                    btn.onclick = function() {
                        const cat = btn.getAttribute('data-collapse-cat');
                        let collapsedCats = JSON.parse(localStorage.getItem('collapsedCategories') || '[]');
                        if (collapsedCats.includes(cat)) {
                            collapsedCats = collapsedats.filter(c => c !== cat);
                        } else {
                            collapsedCats.push(cat);
                        }
                        localStorage.setItem('collapsedCategories', JSON.stringify(collapsedCats));
                        renderAccounts();
                    };
                });
            // Attach event listeners for edit/delete
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = (e) => {
                    editIndex = parseInt(btn.getAttribute('data-idx'));
                    const acc = accounts[editIndex];
                    document.getElementById('accountType').value = acc.type;
                    document.getElementById('accountName').value = acc.name;
                    document.getElementById('accountBalance').value = acc.balance;
                    document.getElementById('accountManagement').value = acc.management || '';
                    document.getElementById('accountInterest').value = acc.interest || '';
                    document.getElementById('accountTarget').value = acc.target || '';
                    document.getElementById('accountContribution').value = acc.contribution || '';
                    document.getElementById('accountSchedule').value = acc.schedule || 'Monthly';
                    document.getElementById('accountExpense').value = acc.expense || '';
                    document.getElementById('accountExpenseSchedule').value = acc.expenseSchedule || 'None';
                    addAccountModal.style.display = 'flex';
                };
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const idx = parseInt(btn.getAttribute('data-idx'));
                    showCustomAlert('Are you sure you want to delete this account?', () => {
                        accounts.splice(idx, 1);
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        renderAccounts();
                    });
                };
        // Custom alert modal logic
        function showCustomAlert(message, onConfirm) {
            const modal = document.getElementById('customAlertModal');
            const msg = document.getElementById('customAlertMessage');
            const cancelBtn = document.getElementById('customAlertCancel');
            const confirmBtn = document.getElementById('customAlertConfirm');
            msg.textContent = message;
            modal.style.display = 'flex';
            function cleanup() {
                modal.style.display = 'none';
                cancelBtn.onclick = null;
                confirmBtn.onclick = null;
            }
            cancelBtn.onclick = () => {
                cleanup();
            };
            confirmBtn.onclick = () => {
                cleanup();
                if (typeof onConfirm === 'function') onConfirm();
            };
        }
            });
            renderSummary();
        }
        renderAccounts();

        addAccountBtn.onclick = () => {
            editIndex = null;
            accountForm.reset();
            addAccountModal.style.display = 'flex';
        };
        cancelAccountBtn.onclick = () => {
            addAccountModal.style.display = 'none';
            accountForm.reset();
            editIndex = null;
        };
        accountForm.onsubmit = (e) => {
            e.preventDefault();
            const type = document.getElementById('accountType').value;
            const name = document.getElementById('accountName').value;
            const balance = document.getElementById('accountBalance').value;
            const management = document.getElementById('accountManagement').value;
            const interest = document.getElementById('accountInterest').value;
            const target = document.getElementById('accountTarget').value;
            const contribution = document.getElementById('accountContribution').value;
            const schedule = document.getElementById('accountSchedule').value;
            const expense = document.getElementById('accountExpense').value;
            const expenseSchedule = document.getElementById('accountExpenseSchedule').value;
            const category = getCategory(type);
            if (!type || !name || !balance || !management) return;
            const accountData = { type, name, balance, category, management, interest, target, contribution, schedule, expense, expenseSchedule };
            if (editIndex !== null) {
                accounts[editIndex] = accountData;
            } else {
                accounts.push(accountData);
            }
            localStorage.setItem('accounts', JSON.stringify(accounts));
            renderAccounts();
            addAccountModal.style.display = 'none';
            accountForm.reset();
            editIndex = null;
        };
        function getMonthsToRetirement() {
            const birthday = localStorage.getItem('birthday');
            const retirementAge = parseInt(localStorage.getItem('retirementAge'));
            if (!birthday || !retirementAge) return 0;
            const birthDate = new Date(birthday);
            const targetDate = new Date(birthDate);
            targetDate.setFullYear(birthDate.getFullYear() + retirementAge);
            const now = new Date();
            let months = (targetDate.getFullYear() - now.getFullYear()) * 12 + (targetDate.getMonth() - now.getMonth());
            if (targetDate.getDate() < now.getDate()) months--;
            return Math.max(months, 0);
        }
        function getPeriods(schedule, months) {
            if (schedule === 'Monthly') return months;
            if (schedule === 'Quarterly') return Math.floor(months / 3);
            if (schedule === 'Annually') return Math.floor(months / 12);
            return 0;
        }
        function getExpensePeriods(schedule, months) {
            if (schedule === 'Monthly') return months;
            if (schedule === 'Quarterly') return Math.floor(months / 3);
            if (schedule === 'Annually') return Math.floor(months / 12);
            return 0;
        }
        function projectAccount(acc, months) {
            let balance = parseFloat(acc.balance || 0);
            let rate = parseFloat(acc.interest || 0) / 100;
            let contrib = parseFloat(acc.contribution || 0);
            let periods = getPeriods(acc.schedule, months);
            let expense = parseFloat(acc.expense || 0);
            let expensePeriods = getExpensePeriods(acc.expenseSchedule, months);
            if (!rate && !contrib && !expense) return balance;
            // Compound interest with contributions and expenses
            let freq = 1;
            if (acc.schedule === 'Monthly') freq = 12;
            if (acc.schedule === 'Quarterly') freq = 4;
            if (acc.schedule === 'Annually') freq = 1;
            let years = months / 12;
            let n = freq * years;
            let r = rate / freq;
            // Future value of a series + initial principal - expenses
            let future = balance * Math.pow(1 + r, n) + contrib * ((Math.pow(1 + r, n) - 1) / r);
            // Subtract future value of expenses
            if (expensePeriods > 0 && expense > 0) {
                let expenseFreq = 1;
                if (acc.expenseSchedule === 'Monthly') expenseFreq = 12;
                if (acc.expenseSchedule === 'Quarterly') expenseFreq = 4;
                if (acc.expenseSchedule === 'Annually') expenseFreq = 1;
                let expenseN = expenseFreq * years;
                let expenseR = rate / expenseFreq;
                let expenseFV = expense * ((Math.pow(1 + expenseR, expenseN) - 1) / expenseR);
                future -= expenseFV;
            }
            return future;
        }
        function renderProjectedSummary() {
            const categories = [
                'Emergency Fund',
                'Retirement',
                'HSA',
                'Taxable Brokerage',
                'Cash Management',
                'Checkings',
                'Savings',
                'Other'
            ];
            const months = getMonthsToRetirement();
            // Pie chart for projected summary
            const projectedBalances = categories.map(cat => {
                return accounts.filter(acc => getCategory(acc.type) === cat)
                    .reduce((sum, acc) => sum + projectAccount(acc, months), 0);
            });
            const projectedPie = document.getElementById('projectedPie').getContext('2d');
            if (window.projectedChart) window.projectedChart.destroy();
            const projectedTotal = projectedBalances.reduce((a, b) => a + b, 0);
            window.projectedChart = new Chart(projectedPie, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: projectedBalances,
                        backgroundColor: [
                            '#4caf50', '#2196f3', '#ff9800', '#9c27b0', '#00bcd4', '#ffc107', '#607d8b', '#8bc34a'
                        ],
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: (document.documentElement.getAttribute('data-theme') === 'dark') ? '#eaf2fb' : '#222'
                            }
                        },
                        doughnutCenterText: {
                            display: true,
                            text: `$${projectedTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = projectedTotal ? (value / projectedTotal * 100) : 0;
                                    return `${context.label}: $${value.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} (${percent.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                },
                plugins: [{
                    id: 'doughnutCenterText',
                    afterDraw: function(chart) {
                            if (chart.config.options.plugins.doughnutCenterText && chart.config.options.plugins.doughnutCenterText.display) {
                                const ctx = chart.ctx;
                                const centerText = chart.config.options.plugins.doughnutCenterText.text;
                                ctx.save();
                                ctx.font = 'bold 1.1rem Segoe UI, Arial';
                                // Detect dark mode
                                let isDark = false;
                                if (document.documentElement.getAttribute('data-theme') === 'dark') {
                                    isDark = true;
                                }
                                ctx.fillStyle = isDark ? '#eaf2fb' : '#222';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                const x = chart.getDatasetMeta(0).data[0].x;
                                const y = chart.getDatasetMeta(0).data[0].y;
                                ctx.fillText(centerText, x, y);
                                ctx.restore();
                            }
                    }
                }]
            });
            // Text list
            const projectedList = document.getElementById('projectedList');
            projectedList.innerHTML = categories.map((cat, i) =>
                `<div style="margin-bottom: 0.3rem; display: flex; justify-content: space-between;">
                    <span>${cat}</span>
                    <span><strong>$${projectedBalances[i].toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</strong></span>
                </div>`
            ).join('');
        }
        function renderSummary() {
            const categories = [
                'Emergency Fund',
                'Retirement',
                'HSA',
                'Taxable Brokerage',
                'Cash Management',
                'Checkings',
                'Savings',
                'Other'
            ];
            const balances = categories.map(cat => {
                return accounts.filter(acc => getCategory(acc.type) === cat)
                    .reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            });
            // Pie chart
            const ctx = document.getElementById('summaryPie').getContext('2d');
            if (window.summaryChart) window.summaryChart.destroy();
            // Calculate total value
            const totalValue = balances.reduce((a, b) => a + b, 0);
            window.summaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: balances,
                        backgroundColor: [
                            '#4caf50', '#2196f3', '#ff9800', '#9c27b0', '#00bcd4', '#ffc107', '#607d8b', '#8bc34a'
                        ],
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: (document.documentElement.getAttribute('data-theme') === 'dark') ? '#eaf2fb' : '#222'
                            }
                        },
                        doughnutCenterText: {
                            display: true,
                            text: `$${totalValue.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue ? (value / totalValue * 100) : 0;
                                    return `${context.label}: $${value.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} (${percent.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                },
                plugins: [{
                    id: 'doughnutCenterText',
                    afterDraw: function(chart) {
                            if (chart.config.options.plugins.doughnutCenterText && chart.config.options.plugins.doughnutCenterText.display) {
                                const ctx = chart.ctx;
                                const centerText = chart.config.options.plugins.doughnutCenterText.text;
                                ctx.save();
                                ctx.font = 'bold 1.1rem Segoe UI, Arial';
                                // Detect dark mode
                                let isDark = false;
                                if (document.documentElement.getAttribute('data-theme') === 'dark') {
                                    isDark = true;
                                }
                                ctx.fillStyle = isDark ? '#eaf2fb' : '#222';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                const x = chart.getDatasetMeta(0).data[0].x;
                                const y = chart.getDatasetMeta(0).data[0].y;
                                ctx.fillText(centerText, x, y);
                                ctx.restore();
                            }
                    }
                }]
            });
            // Text list
            const summaryList = document.getElementById('summaryList');
            summaryList.innerHTML = categories.map((cat, i) =>
                `<div style="margin-bottom: 0.3rem; display: flex; justify-content: space-between;">
                    <span>${cat}</span>
                    <span><strong>$${balances[i].toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</strong></span>
                </div>`
            ).join('');
        }
        // Toggle logic for summary card
        const summaryToggleCurrent = document.getElementById('summaryToggleCurrent');
        const summaryToggleProjected = document.getElementById('summaryToggleProjected');
        const summaryCurrentSection = document.getElementById('summaryCurrentSection');
        const summaryProjectedSection = document.getElementById('summaryProjectedSection');

        function showCurrentSummary() {
            summaryCurrentSection.style.display = '';
            summaryProjectedSection.style.display = 'none';
            summaryToggleCurrent.style.background = '#2196f3';
            summaryToggleCurrent.style.color = '#fff';
            summaryToggleProjected.style.background = 'var(--button-bg)';
            summaryToggleProjected.style.color = 'var(--button-text)';
        }
        function showProjectedSummary() {
            summaryCurrentSection.style.display = 'none';
            summaryProjectedSection.style.display = '';
            summaryToggleCurrent.style.background = 'var(--button-bg)';
            summaryToggleCurrent.style.color = 'var(--button-text)';
            summaryToggleProjected.style.background = '#2196f3';
            summaryToggleProjected.style.color = '#fff';
            renderProjectedSummary();
        }
        summaryToggleCurrent.onclick = showCurrentSummary;
        summaryToggleProjected.onclick = showProjectedSummary;
        // Card flip logic
        const summaryCard = document.getElementById('summaryCard');
        const summaryToggleCurrentBack = document.getElementById('summaryToggleCurrentBack');
        const summaryToggleProjectedBack = document.getElementById('summaryToggleProjectedBack');

        // Card flip logic with correct section display
        summaryToggleProjected.onclick = function() {
            summaryCard.classList.add('flipped');
            showProjectedSummary();
        };
        summaryToggleCurrentBack.onclick = function() {
            summaryCard.classList.remove('flipped');
            showCurrentSummary();
        };
        summaryToggleCurrent.onclick = function() {
            summaryCard.classList.remove('flipped');
            showCurrentSummary();
        };
        summaryToggleProjectedBack.onclick = function() {
            summaryCard.classList.add('flipped');
            showProjectedSummary();
        };
        // Initial state
        showCurrentSummary();

        // Re-render pie charts when theme changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    // Re-render both charts
                    if (summaryCurrentSection.style.display !== 'none') {
                        renderSummary();
                    }
                    if (summaryProjectedSection.style.display !== 'none') {
                        renderProjectedSummary();
                    }
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
    </script>
</body>
</html>
